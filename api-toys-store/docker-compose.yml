services:
  # Base de datos exclusiva para la API
  api-db-toy:
    image: mysql:8.0.43-debian
    container_name: api-db-toy
    networks:
      - shocking-sales-network    
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: api_toys_store
      MYSQL_USER: api_user
      MYSQL_PASSWORD: api_pass
    ports:
      - "3315:3306"  # Puerto diferente a tu proyecto actual (3306)
    volumes:
      - api_db_data_toy:/var/lib/mysql

  # Servidor web para la API
  api-web-toy:
    build: 
      context: .
      dockerfile: Dockerfile
    container_name: api-web-toy
    networks:
      - shocking-sales-network   
    ports:
      - "8000:80"  # Puerto diferente a tu proyecto actual (8080)
    depends_on:
      - api-db-toy
    environment:
      - DB_HOST=api-db-toy
      - DB_DATABASE=api_toys_store
      - DB_USERNAME=api_user
      - DB_PASSWORD=api_pass
    command: > 
      bash -c "
        sleep 15 &&
        cd /var/www/html &&
        composer install --no-interaction --optimize-autoloader &&
        rm -f storage/framework/vite.hot &&
        npm ci || npm install &&
        npm run build &&
        php artisan migrate --force &&
        php artisan config:clear &&
        apache2-foreground
      "

  # phpMyAdmin para la API
  api-phpmyadmin-toy:
    image: phpmyadmin:latest
    container_name: api-phpmyadmin-toy
    networks:
      - shocking-sales-network    
    environment:
      PMA_HOST: api-db-toy
      PMA_USER: root
      PMA_PASSWORD: root
    depends_on:
      - api-db-toy
    ports:
      - "8082:80"  # Puerto diferente a tu proyecto actual (8081)

networks:
  shocking-sales-network:
    external: true

volumes:
  api_db_data_toy:
